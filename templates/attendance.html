{% extends "base.html" %}

{% block title %}Attendance - Smart Presence{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-clipboard-check"></i> Attendance</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('export_attendance', format='csv', date=selected_date) }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-file-csv"></i> Export CSV
            </a>
            <a href="{{ url_for('export_attendance', format='pdf', date=selected_date) }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-file-pdf"></i> Export PDF
            </a>
        </div>
        <button onclick="window.print()" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-print"></i> Print
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-filter"></i> Filter</h5>
                <form method="get" action="{{ url_for('attendance') }}">
                    <div class="input-group">
                        <input type="date" name="date" class="form-control form-control-sm" value="{{ selected_date }}">
                        <button type="submit" class="btn btn-sm btn-primary">Show</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Total</h5>
                <p class="display-4">{{ attendance|length }}</p>
                <p class="mb-0">People present today</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">On Time</h5>
                {% set on_time_count = 0 %}
                {% for record in attendance if record.time <= '09:00:00' %}
                    {% set on_time_count = on_time_count + 1 %}
                {% endfor %}
                <p class="display-4">{{ on_time_count }}</p>
                <p class="mb-0">Before 9:00 AM</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Late</h5>
                {% set late_count = 0 %}
                {% for record in attendance if record.time > '09:00:00' %}
                    {% set late_count = late_count + 1 %}
                {% endfor %}
                <p class="display-4">{{ late_count }}</p>
                <p class="mb-0">After 9:00 AM</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Average Hours</h5>
                {% set total_hours = 0 %}
                {% for record in attendance %}
                    {% set total_hours = total_hours + record.total_hours|default(0) %}
                {% endfor %}
                {% set avg_hours = (total_hours / attendance|length)|round(1) if attendance|length > 0 else 0 %}
                <p class="display-4">{{ avg_hours }}</p>
                <p class="mb-0">Hours per person</p>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Attendance List</h5>
        <span class="badge bg-primary">{{ selected_date }}</span>
    </div>
    <div class="card-body">
        {% if attendance %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Time In</th>
                        <th>Last Seen</th>
                        <th>Duration</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ record.name }}</td>
                        <td>{{ record.time }}</td>
                        <td>{{ record.last_seen }}</td>
                        <td>{{ record.duration }}</td>
                        <td>
                            {% set confidence = record.confidence|float * 100 %}
                            <div class="progress" style="height: 20px;">
                                <div 
                                    class="progress-bar {% if confidence >= 80 %}bg-success{% elif confidence >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                    role="progressbar" 
                                    style="width: {{ confidence }}%;" 
                                    aria-valuenow="{{ confidence }}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                    {{ confidence|int }}%
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-3">
            <p class="text-muted mb-0">No attendance records found for {{ selected_date }}</p>
            
            <!-- Debug information for admins -->
            {% if session.is_admin %}
            <div class="alert alert-info mt-3">
                <h5>Debug Information</h5>
                <p>Selected date: {{ selected_date }}</p>
                <p>Database file: {{ db_file if db_file is defined else 'Not provided' }}</p>
                <p>
                    <a href="{{ url_for('debug_model') }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        View Model Debug
                    </a>
                    <a href="{{ url_for('reset_database') }}" class="btn btn-sm btn-outline-danger" 
                       onclick="return confirm('This will reset the database. Are you sure?')">
                        Reset Database
                    </a>
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
// Only update UI when faces change or every 500ms
let lastUpdateTime = 0;
let lastFacesCount = 0;
const updateInterval = 500; // ms

function updateUI(data) {
    const now = Date.now();
    
    // Skip updates that are too frequent or redundant
    if (now - lastUpdateTime < updateInterval && 
        data.faces.length === lastFacesCount) {
        return;
    }
    
    // Update UI elements here
    // ...
    
    lastUpdateTime = now;
    lastFacesCount = data.faces.length;
}

// Use this in your event handlers
</script>
{% endblock %}